# Anchor 文档

## 技术路径
- 最小化事件通过 Tk `Unmap` 监听，检测窗口进入 `iconic` 状态即隐藏窗口。
- Windows 端托盘化时用 `GetWindowLongW/SetWindowLongW` 清除 `WS_EX_APPWINDOW` 并设置 `WS_EX_TOOLWINDOW`，恢复显示时还原扩展样式避免影响 Alt-Tab。
- 托盘功能基于 `pystray` 与 `Pillow`，在后台线程中创建托盘图标与菜单，提供显示窗口与退出入口。
- 托盘图标优先使用仓库的 `app.ico`，缺失时生成纯色占位图避免崩溃。
- 结算机制在 `maybe_rollover_day` 中以 `WORK_END` 为阈值，避免重复结算并将每日收入写入数据文件内的历史字段。
- 工作日 9:00 前不计入摸鱼收入，且跨天锁屏会保留锁屏起点避免 9 点后重新触发锁屏带薪。
- 数据文件与配置文件迁移至用户本地数据目录（优先 `APPDATA`，否则 `~/.local/share`），启动时自动迁移旧路径数据。

## 修改日志
- v0.1.x feature/refactor/bugfix: 托盘化与依赖补齐、18:00 日结与历史记录、历史记录合并进数据文件。
- v0.2.0 feature: 数据与配置落盘到本地用户目录，自动迁移旧版文件路径。
- v0.2.1 bugfix: 修复18点后不应立即清零，改为次日清零。
- v0.2.2 bugfix: 托盘化时移除任务栏/最小化窗口条目，仅保留托盘图标。
- v0.2.3 feature: 增加托盘与右键菜单“详情”，展示近7天摸鱼趋势弹窗。
- v0.2.4 bugfix: 修复右键重新配置弹窗无法获取焦点的问题。
- v0.2.5 bugfix: 补充 9 点前不计入与跨天锁屏起点延续，避免跨日息屏累积异常。
- v0.2.6 bugfix: 详情弹窗复用已打开窗口并聚焦，避免重复创建。
- v0.2.7 refactor: 清理已完成的后续规划条目，保持规划区仅含未完成事项。
- v0.2.8 refactor: 统一版本常量与命名规范，数据/配置文件切换为结构版本号并新增 schema_version 字段。
- v0.2.9 refactor: 历史记录增加保留策略并减少落盘频率，写盘失败时追加日志便于排查。

## 后续规划思考
- 结合 `maybe_rollover_day` 的日期滚动，在每日早间启动时自动清零当日金额并保存前一日记录，确保统计口径清晰。
