# Anchor 文档

## 版本规范
- 版本号采用 `v主.次.修`，并在修改日志中标注 `feature/refactor/bugfix` 类型。

## 技术路径
- 最小化事件通过 Tk `Unmap` 监听，检测窗口进入 `iconic` 状态即隐藏窗口。
- Windows 端托盘化时用 `GetWindowLongW/SetWindowLongW` 清除 `WS_EX_APPWINDOW` 并设置 `WS_EX_TOOLWINDOW`，恢复显示时还原扩展样式避免影响 Alt-Tab。
- 托盘功能基于 `pystray` 与 `Pillow`，在后台线程中创建托盘图标与菜单，提供显示窗口与退出入口。
- 托盘图标优先使用仓库的 `app.ico`，缺失时生成纯色占位图避免崩溃。
- 结算机制在 `maybe_rollover_day` 中以 `WORK_END` 为阈值，避免重复结算并将每日收入写入数据文件内的历史字段。
- 工作日 9:00 前不计入摸鱼收入，且跨天锁屏会保留锁屏起点避免 9 点后重新触发锁屏带薪。
- 数据文件与配置文件迁移至用户本地数据目录（优先 `APPDATA`，否则 `~/.local/share`），启动时自动迁移旧路径数据。
- 系统能力仅在 Windows 启用：非 Windows 时锁屏与按键检测返回安全默认值，避免硬依赖导致崩溃。
- 配置校验增加工作时段边界检查，避免午休/下班时间配置异常引发计费逻辑错乱。
- 下班后最后使用时间在主循环中根据空闲阈值与锁屏状态记录到数据文件的 `last_after_work_usage` 字段。

## 修改日志
- v0.1.x feature/refactor/bugfix: 托盘化与依赖补齐、18:00 日结与历史记录、历史记录合并进数据文件。
- v0.2.0 feature: 数据与配置落盘到本地用户目录，自动迁移旧版文件路径。
- v0.2.1 bugfix: 修复18点后不应立即清零，改为次日清零。
- v0.2.2 bugfix: 托盘化时移除任务栏/最小化窗口条目，仅保留托盘图标。
- v0.2.3 feature: 增加托盘与右键菜单“详情”，展示近7天摸鱼趋势弹窗。
- v0.2.4 bugfix: 修复右键重新配置弹窗无法获取焦点的问题。
- v0.2.5 bugfix: 补充 9 点前不计入与跨天锁屏起点延续，避免跨日息屏累积异常。
- v0.2.6 bugfix: 详情弹窗复用已打开窗口并聚焦，避免重复创建。
- v0.2.7 refactor: 清理已完成的后续规划条目，保持规划区仅含未完成事项。
- v0.2.8 refactor: 统一版本常量与命名规范，数据/配置文件切换为结构版本号并新增 schema_version 字段。
- v0.2.9 refactor: 历史记录增加保留策略并减少落盘频率，写盘失败时追加日志便于排查。
- v0.2.10 bugfix: 重新配置弹窗改为异步打开并兜底释放 grab，避免弹窗闪退后悬浮窗失去交互。
- v0.2.11 bugfix: 详情弹窗增加打开中保护避免重复实例；配置弹窗延迟 grab 以降低闪退与卡死风险。
- v0.2.12 bugfix: 右键菜单与配置弹窗统一释放 grab，避免闪退/卡死与重复打开异常。
- v0.3.0 refactor: 拆分配置、存储、系统调用与 UI 逻辑模块，入口保持原有启动流程。
- v0.3.1 refactor: 优化 README 与 Anchor 文档结构说明，并补充远景规划与落地路径说明。
- v0.3.2 bugfix: 增强非 Windows 环境降级处理与配置时间边界校验，减少误判与异常配置影响。
- v0.4.0 feature: 记录每日下班后最后使用时间，详情展示近7天最晚使用时刻并优化信息层级。

## 理想规划
- 进军 Web3，成为摸鱼界的代币；当前实现的只是最适合落地的一个小功能。
- 阶段一（现实落地）：完善桌面端体验与数据可信度，打磨计费与统计，后续将持续优化人机交互和视觉。
- 阶段二（资产化雏形）：引入可验证的摸鱼积分与身份体系，支持可视化排行与成就。
- 阶段三（代币化演进）：探索链上发行与治理机制，建立摸鱼生态的激励与协作模式。
